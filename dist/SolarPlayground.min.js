/*! SolarPlayground 22-06-2014 */
!function(){var a={container:{elements:{}},data:{items:{}},calc:{},view:{},ui:{ext:{}}};a.log=function(a,b){a=a||"LOG",window.console.log("["+a+"] "+b)},window.sp=a}(),window.requestNextAnimationFrame=function(){var a=void 0,b=void 0,c=0,d=navigator.userAgent,e=0,f=this;return window.webkitRequestAnimationFrame&&(b=function(a){void 0===a&&(a+=new Date),f.callback(a)},a=window.webkitRequestAnimationFrame,window.webkitRequestAnimationFrame=function(c,d){f.callback=c,a(b,d)}),window.mozRequestAnimationFrame&&(e=d.indexOf("rv:"),-1!=d.indexOf("Gecko")&&(c=d.substr(e+3,3),"2.0"===c&&(window.mozRequestAnimationFrame=void 0))),window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){var b,c;window.setTimeout(function(){b+=new Date,a(b),c+=new Date,f.timeout=1e3/60-(c-b)},f.timeout)}}(),sp.System=function(a){var b;OO.EventEmitter.call(this),this.containers={},a=a||{},b={scenario_dir:"scenarios",scenario_prefix:"scenarios.",directory_sep:"/",width:$(window).width()-100,height:$(window).height()-100},this.config=$.extend(!0,b,a)},OO.mixinClass(sp.System,OO.EventEmitter),sp.System.prototype.setContainer=function(a,b){if(!a)throw Error("sp.System.setContainer must supply a valid container_id.");return this.containers[a]=new sp.container.Manager({container:"#"+a,width:b.width||this.config.width,height:b.height||this.config.height,scenario_dir:this.config.scenario_dir,directory_sep:this.config.directory_sep,scenario_prefix:b.scenario_prefix||this.config.scenario_prefix,buildMode:!1}),this.containers[a]},sp.System.prototype.getContainer=function(a){if(!this.containers)throw Error("Cannot get container, no containers are defined.");return this.containers[a]},sp.System.prototype.getConfig=function(a){return this.config&&a?this.config[a]:this.config},sp.Gui.Loader=function(a){a=a||{},OO.EventEmitter.call(this),this.moduleName=a.module||"ooui",this.module=null,this.scenario=a.scenario,this.settings=a.settings||{},this.container=a.container,this.$spinner=$("<div>").addClass("sp-system-spinner").appendTo(this.container.$container)},OO.mixinClass(sp.Gui.Loader,OO.EventEmitter),sp.Gui.Loader.prototype.initialize=function(){var a;switch(this.module){case"ooui":default:this.module=new sp.Gui.Module.ooui(this.container,this.settings)}return a=this.module.initialize(this.settings),this.$spinner.hide(),a},sp.Gui.Module.Base=function(a,b){b=b||{},OO.EventEmitter.call(this),this.container=a},OO.mixinClass(sp.Gui.Module.Base,OO.EventEmitter),sp.Gui.Module.Base.prototype.initialize=function(){throw new Error("sp.Gui.Module.Initialize must be implemented in child class.")},sp.Gui.Module.Base.prototype.addToPOVList=function(){throw new Error("sp.Gui.Module.addToPOVList must be implemented in child class.")},sp.Gui.Module={},sp.Gui.Module.ooui=function(a,b){b=b||{},sp.Gui.Module.ooui.super.call(this,a,b),this.tools={}},OO.inheritClass(sp.Gui.Module.ooui,sp.Gui.Module.Base),sp.Gui.Module.ooui.prototype.initialize=function(){var a,b;this.toolFactory=new OO.ui.ToolFactory,this.toolGroupFactory=new OO.ui.ToolGroupFactory,this.toolbar=new sp.Gui.Module.ooui.Toolbar(this.container,this.toolFactory,this.toolGroupFactory),this.toolbar.setup([{type:"bar",include:[{group:"playTools"}]},{type:"bar",include:[{group:"viewTools"}]},{type:"menu",indicator:"down",label:"POV",icon:"picture",include:[{group:"povTools"}]}]),this.toolbar.emit("updateState"),a={play:["playTool","playTools","play","Play scenario",null,this.onPlayButtonSelect,function(a){this.setActive(!a)},"pause"],zoomin:["zoominTool","viewTools","zoomin","Zoom in",null,this.onZoomInButtonSelect],zoomout:["zoomoutTool","viewTools","zoomout","Zoom out",null,this.onZoomOutButtonSelect]},this.tools={};for(b in a)this.tools[b]=this.createTool.apply(this,a[b]),this.toolFactory.register(this.tools[b]);return this.container.addToolbar(this.toolbar.$element),this.toolbar.connect(this,{play:["onToolbarEvent","play"]}),this.toolbar.connect(this,{zoom:["onToolbarEvent","zoom"]}),this.toolbar.connect(this,{pov:["onToolbarEvent","pov"]}),this},sp.Gui.Module.ooui.prototype.addToPOVList=function(a,b,c){var d,e=a+"Tool";d=[a,c,b],this.tools[e]=this.createPOVTool.apply(this,d),this.toolFactory.register(this.tools[e])},sp.Gui.Module.ooui.prototype.onToolbarEvent=function(a,b){this.emit(a,b)},sp.Gui.Module.ooui.prototype.onZoomInButtonSelect=function(){this.setActive(!1),this.toolbar.emit("zoom",2e3)},sp.Gui.Module.ooui.prototype.onZoomOutButtonSelect=function(){this.setActive(!1),this.toolbar.emit("zoom",-2e3)},sp.Gui.Module.ooui.prototype.onPlayButtonSelect=function(){this.toggled!==this.toolbar.getContainer().isPaused()&&(this.toggled=!this.toggled,this.setActive(this.toggled),this.toolbar.emit("play",this.toggled))},sp.Gui.Module.ooui.prototype.getToolbar=function(){return this.toolbar},sp.Gui.Module.ooui.prototype.createTool=function(a,b,c,d,e,f,g,h){var i=function(){var a,b={};i.super.apply(this,arguments),this.toggled=!1,a=a=this.toolbar.getContainer().getScenario(),e&&e.call(this),h&&(b[h]="onToolbarUpdate",this.toolbar.getContainer().connect(this,b))};return OO.inheritClass(i,OO.ui.Tool),i.prototype.onSelect=function(){f?f.call(this):(this.toggled=!this.toggled,this.setActive(this.toggled)),this.toolbar.emit("updateState")},i.prototype.onUpdateState=function(){},i.prototype.onToolbarUpdate=function(a){g&&g.call(this,a)},i.static.name=a,i.static.group=b,i.static.icon=c,i.static.title=d,i},sp.Gui.Module.ooui.prototype.createPOVTool=function(a,b,c){var d=function(){d.super.apply(this,arguments),this.toggled=this.toolbar.getContainer().getScenario().getPOV()===a,this.setActive(this.toggled),this.objectName=a,this.toolbar.getContainer().getScenario().connect(this,{povChange:"onUpdateState"})};return OO.inheritClass(d,OO.ui.Tool),d.prototype.onSelect=function(){this.toolbar.getContainer().getScenario().getPOV()!==this.getObjectName()&&this.toolbar.emit("pov",this.getObjectName())},d.prototype.getObjectName=function(){return this.objectName},d.prototype.onUpdateState=function(a){a&&this.setActive(a===this.getObjectName())},d.static.name=a,d.static.group="povTools",d.static.icon=b,d.static.title=c,d},sp.Gui.Module.ooui.Toolbar=function(a,b,c){sp.Gui.Module.ooui.Toolbar.super.call(this,b,c),this.container=a},OO.inheritClass(sp.Gui.Module.ooui.Toolbar,OO.ui.Toolbar),sp.Gui.Module.ooui.Toolbar.prototype.getContainer=function(){return this.container},sp.Scenario.Calculator=function(){},sp.Scenario.Calculator.constants={AU:149597871,G:6.67*Math.pow(10,-11)},sp.Scenario.Calculator.translateTime=function(a,b,c,d){var e;return a=a||2014,b=b||6,c=c||10,d=d||0,e=367*a-7*Math.floor((a+Math.floor((b+9)/12))/4)+275*Math.floor(b/9)+D-730530,e+=d/24},sp.Scenario.Calculator.getJDNTime=function(a,b,c,d,e,f){var g,h=Math.floor((14-b)/12),i=a+4800-h,j=b+12*h-3;return d=d||12,e=e||0,f=f||0,g=c+Math.floor((153*j+2)/5)+365*i+Math.floor(i/4)-Math.floor(i/100)+Math.floor(i/400)+32045,JD=g+(d-12)/24+e/1440+f/86400,JD-2451545},sp.Scenario.Calculator.solveKepler=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p={},q=1e3,r=Math.pow(10,-4),s=function(a){return a*(180/Math.PI)},t=function(a,b){for(var c=Math.PI/180*a,d=b+c+Math.sin(s(b)),e=1;q--&&Math.abs(e)>r;)dM=b-(d-c*Math.sin(s(d))),e=dM/(1-a*Math.cos(s(d))),d+=e;return s(d)};return a?(c=b||0,l=a.b||0,m=a.c||0,n=a.f||0,o=a.s||0,d=a.a[0]+a.a[1]*c,e=a.e[0]+a.e[1]*c,f=a.I[0]+a.I[1]*c,g=a.L[0]+a.L[1]*c,h=a.long_peri[0]+a.long_peri[1]*c,i=a.long_node[0]+a.long_node[1]*c,j=h-i,k=g-h+l*Math.pow(c,2)+m*Math.cos(n*c)+o*Math.sin(n*c),k=s(k)%180,E=t(e,k),x=d*(Math.cos(E)-e),y=d*Math.sqrt(1-Math.pow(e,2))*Math.sin(E),z=0,p={x:x,y:y,z:y}):null},sp.Scenario.CelestialObject=function(a){a=a||{},OO.EventEmitter.call(this),this.cache={},this.trails=[],this.frameCounter=0,this.trailsFrameGap=2,this.numTrailPoints=80,this.name=a.name||"",this.description=a.description||"",this.view=a.graphic||{},this.transform={x:0,y:0,angle:0,scale:1},this.vars=a.vars,this.initial_position=a.initial_position||{x:0,y:0},this.orbiting=null,this.type=a.type||"planet",this.radius=Number(a.vars.r)||10},OO.mixinClass(sp.Scenario.CelestialObject,OO.EventEmitter),sp.Scenario.CelestialObject.prototype.getSpaceCoordinates=function(b){var c,d;return b=b||0,this.orbiting?(this.vars.p||(a=this.vars.a[0],d=sp.Scenario.Calculator.constants.G,c=this.orbiting.getMass(),this.vars.p=2*Math.PI*Math.sqrt(Math.pow(a,3)/(d*c))),this.coordinates=sp.Scenario.Calculator.solveKepler(this.vars,b)):this.coordinates={x:0,y:0,z:0},this.coordinates},sp.Scenario.CelestialObject.prototype.storeTrailPoint=function(a){this.trails.push(a),this.trails.length>this.numTrailPoints&&this.trails.shift()},sp.Scenario.CelestialObject.prototype.getTrailPoints=function(){return this.trails},sp.Scenario.CelestialObject.prototype.flushTrailPoints=function(){this.trails=[],this.frameCounter=0},sp.Scenario.CelestialObject.prototype.getType=function(){return this.type},sp.Scenario.CelestialObject.prototype.getName=function(){return this.name},sp.Scenario.CelestialObject.prototype.getDescription=function(){return this.description},sp.Scenario.CelestialObject.prototype.setOrbit=function(a){this.orbiting=a},sp.Scenario.CelestialObject.prototype.getOrbit=function(){return this.orbiting},sp.Scenario.CelestialObject.prototype.setName=function(a){this.name=a},sp.Scenario.CelestialObject.prototype.setDescription=function(a){this.description=a},sp.Scenario.CelestialObject.prototype.getMass=function(){return this.vars.m},sp.Scenario.CelestialObject.prototype.getView=function(){return this.view},sp.Scenario.CelestialObject.prototype.getRadius=function(){return this.vars.r},sp.Container=function(a){OO.EventEmitter.call(this),this.config=a||{},this.scenario=null,this.$container=$(a.container).addClass("sp-container"),this.$canvas=$("<canvas>").addClass("sp-container-canvas").attr("width",a.width).attr("height",a.height).appendTo(this.$container),guiLoader=new sp.Gui.Loader({module:"ooui",container:this}),this.gui=guiLoader.initialize(),this.canvasMouseMoving=!1,this.canvasMouseStartPosition={},this.gui.connect(this,{play:"onGuiPlay"}),this.gui.connect(this,{zoom:"onGuiZoom"}),this.gui.connect(this,{pov:"onGuiPOV"}),this.$canvas.on("mousedown",$.proxy(this.onCanvasMouseDown,this)),this.$canvas.on("mousemove",$.proxy(this.onCanvasMouseMove,this)),this.$canvas.on("mouseup",$.proxy(this.onCanvasMouseUp,this)),this.$canvas.on("mouseout",$.proxy(this.onCanvasMouseUp,this))},OO.mixinClass(sp.Container,OO.EventEmitter),sp.Container.prototype.loadFromFile=function(a){var b,c=this.config.scenario_dir+this.config.directory_sep;a=a||"example",b="scenario."+a+".json",$.getJSON(c+b).done($.proxy(function(a){this.loadFromObject(a)},this)).fail(function(){sp.log("Error","Scenario "+b+' not found in directory "'+c+'"')})},sp.Container.prototype.loadFromObject=function(a){var b;a=a||{},scenario=new sp.Scenario(this,a),this.setScenario(scenario),this.scenario.draw(0),b=this.scenario.getAllObjects();for(o in b)this.gui.addToPOVList(o,b[o].getName());return this.emit("scenarioLoaded",this.scenario),this},sp.Container.prototype.onScenarioPause=function(a){this.emit("pause",a)},sp.Container.prototype.onGuiPlay=function(a){this.scenario.togglePaused(!a)},sp.Container.prototype.onGuiZoom=function(a){this.scenario.setZoom(a)},sp.Container.prototype.onGuiPOV=function(a){this.scenario.setPOV(a)},sp.Container.prototype.onCanvasMouseDown=function(a){this.canvasMouseMoving=!0,this.mouseStartingPoint={x:a.pageX,y:a.pageY},this.scenario&&(this.scenarioCenterPoint=this.scenario.getCenterPoint()),this.emit("canvasMouseDown")},sp.Container.prototype.onCanvasMouseMove=function(a){this.canvasMouseMoving&&!$.isEmptyObject(this.mouseStartingPoint)&&(dx=a.pageX-this.mouseStartingPoint.x,dy=a.pageY-this.mouseStartingPoint.y,this.scenario.setCenterPoint(dx+this.scenarioCenterPoint.x,dy+this.scenarioCenterPoint.y),this.scenario.flushAllTrails(),this.scenario.clearCanvas(),this.scenario.draw())},sp.Container.prototype.onCanvasMouseUp=function(){this.canvasMouseMoving=!1,this.mouseStartingPoint={},this.scenarioCenterPoint={},this.emit("canvasMouseUp")},sp.Container.prototype.addToolbar=function(a,b){b=b||"top","top"===b?this.$container.prepend(a):this.$container.append(a)},sp.Container.prototype.getContext=function(){return this.$canvas[0].getContext("2d")},sp.Container.prototype.getCanvasDimensions=function(){return{width:this.$canvas.width(),height:this.$canvas.height()}},sp.Container.prototype.setScenario=function(a){this.scenario=a,this.scenario.connect(this,{pause:"onScenarioPause"})},sp.Container.prototype.getScenario=function(){return this.scenario},sp.Container.prototype.togglePaused=function(a){this.isPaused()!==a&&(this.scenario.togglePaused(a),this.emit("pause",a))},sp.Container.prototype.setZoom=function(a){this.scenario.getZoom()!==a&&(this.scenario.setZoom(a),this.emit("zoom",a))},sp.Container.prototype.isPaused=function(){return this.scenario.isPaused()},sp.Gui={},sp.Scenario=function(a,b){var c;OO.EventEmitter.call(this),this.container=a,this.context=this.container.getContext(),this.paused=!0,this.objects={},this.config=b.config||{},c=this.container.getCanvasDimensions(),this.viewpoint=new sp.Viewpoint({zoom:this.config.init_zoom||1,centerPoint:{x:c.width/2,y:c.height/2},yaw:0,pitch:0,scale:{orbit:this.config.orbit_scale||.5*Math.pow(10,-5),planets:this.config.planet_scale}}),this.showTrails=this.config.show_trails||!1,this.frameCounter=0,this.trailsFrameGap=5,this.pov_key=this.config.init_pov,this.pov_object=null,this.date=this.config.start_time||{day:1,month:1,year:2e3},this.time=0,this.speed=this.config.init_speed||1,this.processObjects(b.objects||{})},OO.mixinClass(sp.Scenario,OO.EventEmitter),sp.Scenario.prototype.processObjects=function(a){var b,c,d={star:[],planet:[]};for(b in a)this.objects[b]=new sp.Scenario.CelestialObject(a[b]),a[b].vars.r&&("star"===a[b].type?d.star.push(Number(a[b].vars.r)):d.planet.push(Number(a[b].vars.r)));this.viewpoint.setRadiiList(d);for(c in this.objects)a[c]&&this.objects[a[c].orbiting]&&this.objects[c].setOrbit(this.objects[a[c].orbiting]);this.pov_key&&this.objects[this.pov_key]&&(this.pov_object=this.objects[this.pov_key],this.viewpoint.setPOV(this.objects[this.pov_key].getSpaceCoordinates(0)))},sp.Scenario.prototype.setPOV=function(a){a&&this.objects[a]&&this.pov_key!==a&&(this.pov_key=a,this.pov_object=this.objects[this.pov_key],this.viewpoint.setPOV(this.objects[this.pov_key].getSpaceCoordinates(0)),this.clearCanvas(),this.flushAllTrails(),this.draw(),this.emit("povChange",this.pov_key))},sp.Scenario.prototype.getPOV=function(){return this.pov_key},sp.Scenario.prototype.draw=function(a,b){var c,d,e,f,g,h;a=a||this.time;for(c in this.objects)if(d=this.objects[c].getSpaceCoordinates(a),c===this.pov_key&&this.viewpoint.setPOV(d),e=this.viewpoint.getCoordinates(d)){if(f=this.objects[c].getView(),g=this.viewpoint.getRadius(this.objects[c].getRadius(),this.objects[c].getType()),!b&&this.showTrails&&c!==this.pov_key)for(this.frameCounter++,this.frameCounter>=this.trailsFrameGap&&(this.objects[c].storeTrailPoint(e),this.frameCounter=0),h=this.objects[c].getTrailPoints(),i=0;i<h.length;i++)this.drawCircle(this.context,h[i],1,f.color||"#FF005D");this.drawCircle(this.context,e,g,f.color,"star"===this.objects[c].getType())}},sp.Scenario.prototype.drawCircle=function(a,b,c,d,e){a.save(),a.beginPath(),a.arc(b.x,b.y,c||5,0,2*Math.PI,!1),a.fillStyle=d||"white",e&&(a.shadowColor=d||"white",a.shadowBlur=20,a.shadowOffsetX=0,a.shadowOffsetY=0),a.fill(),a.restore()},sp.Scenario.prototype.clearCanvas=function(a,b){var c=this.container.getCanvasDimensions();a=a||this.context,b=b||{},b.left=b.left||0,b.top=b.top||0,b.width=b.width||c.width,b.height=b.height||c.height,a.clearRect(b.left,b.top,b.width,b.height)},sp.Scenario.prototype.flushAllTrails=function(){var a;for(a in this.objects)this.objects[a].flushTrailPoints()},sp.Scenario.prototype.run=function(){this.paused||(this.clearCanvas(this.context),this.draw(this.time),this.time+=1e-10*this.speed,window.requestNextAnimationFrame($.proxy(this.run,this)))},sp.Scenario.prototype.getAllObjects=function(){return this.objects},sp.Scenario.prototype.togglePaused=function(a){void 0===a&&(a=!this.paused),a=!!a,this.paused=a,this.run(),this.emit("pause",this.paused)},sp.Scenario.prototype.isPaused=function(){return this.paused},sp.Scenario.prototype.pause=function(){this.togglePaused(!0)},sp.Scenario.prototype.resume=function(){this.togglePaused(!1),this.run()},sp.Scenario.prototype.setZoom=function(a){this.viewpoint.setZoom(a),this.flushAllTrails(),this.isPaused()&&(this.clearCanvas(),this.draw(this.time,!0))},sp.Scenario.prototype.getZoom=function(){return this.viewpoint.getZoom()},sp.Scenario.prototype.setCenterPoint=function(a,b){this.viewpoint.setCenterPoint(a,b),this.flushAllTrails(),this.isPaused()&&(this.clearCanvas(),this.draw(this.time,!0))},sp.Scenario.prototype.getCenterPoint=function(){return this.viewpoint.getCenterPoint()},sp.Scenario.prototype.addToCenterPoint=function(a,b){this.viewpoint.addToCenterPoint(a,b)},sp.Viewpoint=function(a){OO.EventEmitter.call(this),this.config=a||{},this.zoom=this.config.zoom||1,this.orbit_scale=this.config.orbit_scale||1,this.centerPoint=this.config.centerPoint,this.yaw=this.config.yaw,this.pitch=this.config.pitch,this.pov={x:0,y:0,z:0},this.radii_list=null,this.radii={star:[25,30,32,35],planet:[4,8,10,12,14,16]},this.radius_step={star:0,planet:0}},OO.mixinClass(sp.Viewpoint,OO.EventEmitter),sp.Viewpoint.prototype.setPOV=function(a){a&&(a.x!==this.pov.x||a.y!==this.pov.y)&&(this.pov=a,this.emit("changePOV",a))},sp.Viewpoint.prototype.getCoordinates=function(a){var b=Math.cos(this.yaw),c=Math.sin(this.yaw),d=Math.cos(this.pitch),e=Math.sin(this.pitch),f=this.centerPoint.x,g=this.centerPoint.y,h=Math.sqrt(this.orbit_scale*this.zoom);return x=(a.x-this.pov.x)*h,y=(a.y-this.pov.y)*h,z=(a.z-this.pov.z)*h,destination={x:x*b-y*c+f,y:x*c+y*b},destination.z=destination.y*e,destination.y=destination.y*d+g,destination},sp.Viewpoint.prototype.setRadiiList=function(a){var b,c;this.radii_list=a;for(b in this.radii_list)this.radii_list[b].sort(function(a,b){return a-b}),c=this.radii_list[b][this.radii_list[b].length-1]-this.radii_list[b][0],this.radius_step[b]=c/this.radii[b].length},sp.Viewpoint.prototype.getRadius=function(a,b){var c,d,e=this.radius_step[b]||1;return b=b||"planet",d=Math.floor(a/e),d>this.radii[b].length-1&&(d=this.radii[b].length-1),c=Math.sqrt(this.radii[b][d]*this.zoom)/100,c>=2?c:2},sp.Viewpoint.prototype.setZoom=function(a){this.zoom+=a},sp.Viewpoint.prototype.getZoom=function(){return this.zoom},sp.Viewpoint.prototype.setCenterPoint=function(a,b){a=a||this.centerPoint.x,b=b||this.centerPoint.y,this.centerPoint={x:a,y:b}},sp.Viewpoint.prototype.getCenterPoint=function(){return this.centerPoint},sp.Viewpoint.prototype.addToCenterPoint=function(a,b){a=a||0,b=b||0,this.centerPoint.x+=a,this.centerPoint.y+=b},sp.calc.Calculator=function(){},sp.calc.Calculator.constants={AU:149597871,G:6.67*Math.pow(10,-11)},sp.calc.Calculator.translateTime=function(a,b,c,d){var e;return a=a||2014,b=b||6,c=c||10,d=d||0,e=367*a-7*Math.floor((a+Math.floor((b+9)/12))/4)+275*Math.floor(b/9)+D-730530,e+=d/24},sp.calc.Calculator.getJDNTime=function(a,b,c,d,e,f){var g,h=Math.floor((14-b)/12),i=a+4800-h,j=b+12*h-3;return d=d||12,e=e||0,f=f||0,g=c+Math.floor((153*j+2)/5)+365*i+Math.floor(i/4)-Math.floor(i/100)+Math.floor(i/400)+32045,JD=g+(d-12)/24+e/1440+f/86400,JD-2451545},sp.calc.Calculator.solveKepler=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p={},q=1e3,r=Math.pow(10,-4),s=function(a){return a*(180/Math.PI)},t=function(a,b){for(var c=Math.PI/180*a,d=b+c+Math.sin(s(b)),e=1;q--&&Math.abs(e)>r;)dM=b-(d-c*Math.sin(s(d))),e=dM/(1-a*Math.cos(s(d))),d+=e;return s(d)};return a?(c=b||0,l=a.b||0,m=a.c||0,n=a.f||0,o=a.s||0,d=a.a[0]+a.a[1]*c,e=a.e[0]+a.e[1]*c,f=a.I[0]+a.I[1]*c,g=a.L[0]+a.L[1]*c,h=a.long_peri[0]+a.long_peri[1]*c,i=a.long_node[0]+a.long_node[1]*c,j=h-i,k=g-h+l*Math.pow(c,2)+m*Math.cos(n*c)+o*Math.sin(n*c),k=s(k)%180,E=t(e,k),x=d*(Math.cos(E)-e),y=d*Math.sqrt(1-Math.pow(e,2))*Math.sin(E),z=0,p={x:x,y:y,z:y}):null},sp.container.Loader=function(a){OO.EventEmitter.call(this),this.config=a||{}},sp.container.Loader.prototype.loadFromFile=function(a){var b,c,d=this.scenario_prefix||"",e=this.config.scenario_dir+this.config.directory_sep;return c=$.Deferred(),a=a||"example",b=d+a+".json",$.getJSON(e+b).done($.proxy(function(a){c.resolve(a)},this)).fail(function(){sp.log("Error","Scenario "+b+' not found in directory "'+e+'"'),c.reject()}),c},sp.container.Loader.prototype.loadFromObject=function(a){var b;a=a||{},scenario=new sp.data.Scenario(this,a),this.setScenario(scenario),b=this.scenario.getAllObjects();for(o in b)this.gui.addToPOVList(o,b[o].getName());this.emit("scenarioLoaded",this.scenario)},OO.mixinClass(sp.container.Loader,OO.EventEmitter),sp.container.Manager=function(a){OO.EventEmitter.call(this),this.config=a||{},this.scenario=null,this.loader=new sp.container.Loader,this.$container=$(a.container).addClass("sp-container"),this.screen=new sp.container.Screen,this.$container.append(this.screen.$canvas),guiLoader=new sp.ui.Loader({module:"ooui",container:this}),this.gui=guiLoader.initialize(),this.gui.connect(this,{play:"onGuiPlay"}),this.gui.connect(this,{zoom:"onGuiZoom"}),this.gui.connect(this,{pov:"onGuiPOV"})},OO.mixinClass(sp.container.Manager,OO.EventEmitter),sp.container.Manager.prototype.loadFromFile=function(a){var b=$.Deferred();return this.loader.loadFromFile(a).done($.proxy(function(a){scenario=new sp.data.Scenario(this,a),this.setScenario(scenario),b.resolve()})),b},sp.container.Manager.prototype.onScenarioPause=function(a){this.emit("pause",a)},sp.container.Manager.prototype.onGuiPlay=function(a){this.scenario.togglePaused(!a)},sp.container.Manager.prototype.onGuiZoom=function(a){this.scenario.setZoom(a)},sp.container.Manager.prototype.onGuiPOV=function(a){this.scenario.setPOV(a)},sp.container.Manager.prototype.addToolbar=function(a,b){b=b||"top","top"===b?this.$container.prepend(a):this.$container.append(a)},sp.container.Manager.prototype.setScenario=function(a){this.scenario=a,this.scenario.connect(this,{pause:"onScenarioPause"})},sp.container.Manager.prototype.getScenario=function(){return this.scenario},sp.container.Manager.prototype.togglePaused=function(a){this.isPaused()!==a&&(this.scenario.togglePaused(a),this.emit("pause",a))},sp.container.Manager.prototype.setZoom=function(a){this.scenario.getZoom()!==a&&(this.scenario.setZoom(a),this.emit("zoom",a))},sp.container.Manager.prototype.isPaused=function(){return this.scenario.isPaused()},sp.container.Screen=function(a){this.config=a||{},OO.EventEmitter.call(this),this.canvasCenterPoint={x:0,y:0},this.$canvas=$("<canvas>").addClass("sp-container-canvas").attr("width",this.config.width).attr("height",this.config.height),this.$canvas.on("mousedown",$.proxy(this.onCanvasMouseDown,this)),this.$canvas.on("mousemove",$.proxy(this.onCanvasMouseMove,this)),this.$canvas.on("mouseup",$.proxy(this.onCanvasMouseUp,this)),this.$canvas.on("mouseout",$.proxy(this.onCanvasMouseUp,this))},OO.mixinClass(sp.container.Screen,OO.EventEmitter),sp.container.Screen.prototype.onCanvasMouseDown=function(a){this.canvasMouseMoving=!0,this.mouseStartingPoint={x:a.pageX,y:a.pageY},this.emit("drag","start")},sp.container.Screen.prototype.onCanvasMouseMove=function(a){var b;this.canvasMouseMoving&&!$.isEmptyObject(this.mouseStartingPoint)&&(dx=a.pageX-this.mouseStartingPoint.x,dy=a.pageY-this.mouseStartingPoint.y,b={x:dx+this.scenarioCenterPoint.x,y:dy+this.scenarioCenterPoint.y},this.emit("drag","during",b))},sp.container.Screen.prototype.onCanvasMouseUp=function(){this.canvasMouseMoving=!1,this.mouseStartingPoint={},this.canvasCenterPoint={},this.emit("drag","end")},sp.container.Screen.prototype.setCenterPoint=function(a,b){this.canvasCenterPoint={x:a,y:b}},sp.container.Screen.prototype.getCenterPoint=function(){return this.canvasCenterPoint},sp.container.Screen.prototype.getContext=function(){return this.$canvas[0].getContext("2d")},sp.container.Screen.prototype.getCanvasDimensions=function(){return{width:this.$canvas.width(),height:this.$canvas.height()}},sp.data.Scenario=function(a,b){var c;OO.EventEmitter.call(this),this.screen=a,this.paused=!0,this.objects={},this.config=b.config||{},c=this.screen.getCanvasDimensions(),this.view=new sp.view.Converter({zoom:this.config.init_zoom||1,centerPoint:{x:c.width/2,y:c.height/2},yaw:0,pitch:0,scale:{orbit:this.config.orbit_scale||.5*Math.pow(10,-5),planets:this.config.planet_scale}}),this.showTrails=this.config.show_trails||!1,this.frameCounter=0,this.trailsFrameGap=5,this.pov_key=this.config.init_pov,this.pov_object=null,this.date=this.config.start_time||{day:1,month:1,year:2e3},this.time=0,this.speed=this.config.init_speed||1,this.processObjects(b.objects||{}),this.screen.connect(this,{drag:"onScreenDrag"})},OO.mixinClass(sp.data.Scenario,OO.EventEmitter),sp.sp.data.Scenario.prototype.onScreenDrag=function(a,b){"start"===a?this.screen.setCenterPoint(this.getCenterPoint()):"during"===a?(this.setCenterPoint(b.x,b.y),this.flushAllTrails(),this.clearCanvas(),this.draw()):"end"===a&&this.screen.setCenterPoint(this.getCenterPoint())},sp.data.Scenario.prototype.processObjects=function(a){var b,c,d={star:[],planet:[]};for(b in a)this.objects[b]=new sp.data.Scenario.CelestialBody(a[b]),a[b].vars.r&&("star"===a[b].type?d.star.push(Number(a[b].vars.r)):d.planet.push(Number(a[b].vars.r)));this.view.setRadiiList(d);for(c in this.objects)a[c]&&this.objects[a[c].orbiting]&&this.objects[c].setOrbit(this.objects[a[c].orbiting]);this.pov_key&&this.objects[this.pov_key]&&(this.pov_object=this.objects[this.pov_key],this.view.setPOV(this.objects[this.pov_key].getSpaceCoordinates(0)))},sp.data.Scenario.prototype.setPOV=function(a){a&&this.objects[a]&&this.pov_key!==a&&(this.pov_key=a,this.pov_object=this.objects[this.pov_key],this.viewpoint.setPOV(this.objects[this.pov_key].getSpaceCoordinates(0)),this.clearCanvas(),this.flushAllTrails(),this.draw(),this.emit("povChange",this.pov_key))},sp.data.Scenario.prototype.getPOV=function(){return this.pov_key},sp.data.Scenario.prototype.draw=function(a,b){var c,d,e,f,g,h;a=a||this.time;for(c in this.objects)if(d=this.objects[c].getSpaceCoordinates(a),c===this.pov_key&&this.viewpoint.setPOV(d),e=this.viewpoint.getCoordinates(d)){if(f=this.objects[c].getView(),g=this.viewpoint.getRadius(this.objects[c].getRadius(),this.objects[c].getType()),!b&&this.showTrails&&c!==this.pov_key)for(this.frameCounter++,this.frameCounter>=this.trailsFrameGap&&(this.objects[c].storeTrailPoint(e),this.frameCounter=0),h=this.objects[c].getTrailPoints(),i=0;i<h.length;i++)this.drawCircle(this.context,h[i],1,f.color||"#FF005D");this.drawCircle(this.context,e,g,f.color,"star"===this.objects[c].getType())}},sp.data.Scenario.prototype.drawCircle=function(a,b,c,d,e){a.save(),a.beginPath(),a.arc(b.x,b.y,c||5,0,2*Math.PI,!1),a.fillStyle=d||"white",e&&(a.shadowColor=d||"white",a.shadowBlur=20,a.shadowOffsetX=0,a.shadowOffsetY=0),a.fill(),a.restore()},sp.data.Scenario.prototype.clearCanvas=function(a,b){var c=this.container.getCanvasDimensions();a=a||this.context,b=b||{},b.left=b.left||0,b.top=b.top||0,b.width=b.width||c.width,b.height=b.height||c.height,a.clearRect(b.left,b.top,b.width,b.height)},sp.data.Scenario.prototype.flushAllTrails=function(){var a;for(a in this.objects)this.objects[a].flushTrailPoints()},sp.data.Scenario.prototype.run=function(){this.paused||(this.clearCanvas(this.context),this.draw(this.time),this.time+=1e-10*this.speed,window.requestNextAnimationFrame($.proxy(this.run,this)))},sp.data.Scenario.prototype.getAllObjects=function(){return this.objects},sp.data.Scenario.prototype.togglePaused=function(a){void 0===a&&(a=!this.paused),a=!!a,this.paused=a,this.run(),this.emit("pause",this.paused)},sp.data.Scenario.prototype.isPaused=function(){return this.paused},sp.data.Scenario.prototype.pause=function(){this.togglePaused(!0)},sp.data.Scenario.prototype.resume=function(){this.togglePaused(!1),this.run()},sp.data.Scenario.prototype.setZoom=function(a){this.viewpoint.setZoom(a),this.flushAllTrails(),this.isPaused()&&(this.clearCanvas(),this.draw(this.time,!0))},sp.data.Scenario.prototype.getZoom=function(){return this.viewpoint.getZoom()},sp.data.Scenario.prototype.setCenterPoint=function(a,b){this.viewpoint.setCenterPoint(a,b),this.flushAllTrails(),this.isPaused()&&(this.clearCanvas(),this.draw(this.time,!0))},sp.data.Scenario.prototype.getCenterPoint=function(){return this.view.getCenterPoint()},sp.data.Scenario.prototype.addToCenterPoint=function(a,b){this.view.addToCenterPoint(a,b)},sp.data.items.CelestialBody=function(a){a=a||{},OO.EventEmitter.call(this),this.cache={},this.trails=[],this.frameCounter=0,this.trailsFrameGap=2,this.numTrailPoints=80,this.name=a.name||"",this.description=a.description||"",this.view=a.graphic||{},this.transform={x:0,y:0,angle:0,scale:1},this.vars=a.vars,this.initial_position=a.initial_position||{x:0,y:0},this.orbiting=null,this.type=a.type||"planet",this.radius=Number(a.vars.r)||10},OO.mixinClass(sp.data.items.CelestialBody,OO.EventEmitter),sp.data.items.CelestialBody.prototype.getSpaceCoordinates=function(b){var c,d;return b=b||0,this.orbiting?(this.vars.p||(a=this.vars.a[0],d=sp.Scenario.Calculator.constants.G,c=this.orbiting.getMass(),this.vars.p=2*Math.PI*Math.sqrt(Math.pow(a,3)/(d*c))),this.coordinates=sp.Scenario.Calculator.solveKepler(this.vars,b)):this.coordinates={x:0,y:0,z:0},this.coordinates},sp.data.items.CelestialBody.prototype.storeTrailPoint=function(a){this.trails.push(a),this.trails.length>this.numTrailPoints&&this.trails.shift()},sp.data.items.CelestialBody.prototype.getTrailPoints=function(){return this.trails},sp.data.items.CelestialBody.prototype.flushTrailPoints=function(){this.trails=[],this.frameCounter=0},sp.data.items.CelestialBody.prototype.getType=function(){return this.type},sp.data.items.CelestialBody.prototype.getName=function(){return this.name},sp.data.items.CelestialBody.prototype.getDescription=function(){return this.description},sp.data.items.CelestialBody.prototype.setOrbit=function(a){this.orbiting=a},sp.data.items.CelestialBody.prototype.getOrbit=function(){return this.orbiting},sp.data.items.CelestialBody.prototype.setName=function(a){this.name=a},sp.data.items.CelestialBody.prototype.setDescription=function(a){this.description=a},sp.data.items.CelestialBody.prototype.getMass=function(){return this.vars.m},sp.data.items.CelestialBody.prototype.getView=function(){return this.view},sp.data.items.CelestialBody.prototype.getRadius=function(){return this.vars.r},sp.ui.ext.ooui.Mod={},sp.ui.ext.ooui.Mod.Play=function(a,b){b=b||{},sp.ui.ext.ooui.Mod.Play.super.call(this,a,b),this.tools={}},OO.inheritClass(sp.ui.ext.ooui.Mod.Play,sp.Gui.Module.Base),sp.ui.ext.ooui.Mod.Play.prototype.initialize=function(){var a,b;this.toolFactory=new OO.ui.ToolFactory,this.toolGroupFactory=new OO.ui.ToolGroupFactory,this.toolbar=new sp.ui.ext.ooui.Toolbar(this.container,this.toolFactory,this.toolGroupFactory),this.toolbar.setup([{type:"bar",include:[{group:"playTools"}]},{type:"bar",include:[{group:"viewTools"}]},{type:"menu",indicator:"down",label:"POV",icon:"picture",include:[{group:"povTools"}]}]),this.toolbar.emit("updateState"),a={play:["playTool","playTools","play","Play scenario",null,this.onPlayButtonSelect,function(a){this.setActive(!a)},"pause"],zoomin:["zoominTool","viewTools","zoomin","Zoom in",null,this.onZoomInButtonSelect],zoomout:["zoomoutTool","viewTools","zoomout","Zoom out",null,this.onZoomOutButtonSelect]},this.tools={};for(b in a)this.tools[b]=this.createTool.apply(this,a[b]),this.toolFactory.register(this.tools[b]);return this.container.addToolbar(this.toolbar.$element),this.toolbar.connect(this,{play:["onToolbarEvent","play"]}),this.toolbar.connect(this,{zoom:["onToolbarEvent","zoom"]}),this.toolbar.connect(this,{pov:["onToolbarEvent","pov"]}),this
},sp.ui.ext.ooui.Mod.Play.prototype.addToPOVList=function(a,b,c){var d,e=a+"Tool";d=[a,c,b],this.tools[e]=this.createPOVTool.apply(this,d),this.toolFactory.register(this.tools[e])},sp.ui.ext.ooui.Mod.Play.prototype.onToolbarEvent=function(a,b){this.emit(a,b)},sp.ui.ext.ooui.Mod.Play.prototype.onZoomInButtonSelect=function(){this.setActive(!1),this.toolbar.emit("zoom",2e3)},sp.ui.ext.ooui.Mod.Play.prototype.onZoomOutButtonSelect=function(){this.setActive(!1),this.toolbar.emit("zoom",-2e3)},sp.ui.ext.ooui.Mod.Play.prototype.onPlayButtonSelect=function(){this.toggled!==this.toolbar.getContainer().isPaused()&&(this.toggled=!this.toggled,this.setActive(this.toggled),this.toolbar.emit("play",this.toggled))},sp.ui.ext.ooui.Mod.Play.prototype.getToolbar=function(){return this.toolbar},sp.ui.ext.ooui.Mod.Play.prototype.createTool=function(a,b,c,d,e,f,g,h){var i=function(){var a,b={};i.super.apply(this,arguments),this.toggled=!1,a=a=this.toolbar.getContainer().getScenario(),e&&e.call(this),h&&(b[h]="onToolbarUpdate",this.toolbar.getContainer().connect(this,b))};return OO.inheritClass(i,OO.ui.Tool),i.prototype.onSelect=function(){f?f.call(this):(this.toggled=!this.toggled,this.setActive(this.toggled)),this.toolbar.emit("updateState")},i.prototype.onUpdateState=function(){},i.prototype.onToolbarUpdate=function(a){g&&g.call(this,a)},i.static.name=a,i.static.group=b,i.static.icon=c,i.static.title=d,i},sp.ui.ext.ooui.Mod.Play.prototype.createPOVTool=function(a,b,c){var d=function(){d.super.apply(this,arguments),this.toggled=this.toolbar.getContainer().getScenario().getPOV()===a,this.setActive(this.toggled),this.objectName=a,this.toolbar.getContainer().getScenario().connect(this,{povChange:"onUpdateState"})};return OO.inheritClass(d,OO.ui.Tool),d.prototype.onSelect=function(){this.toolbar.getContainer().getScenario().getPOV()!==this.getObjectName()&&this.toolbar.emit("pov",this.getObjectName())},d.prototype.getObjectName=function(){return this.objectName},d.prototype.onUpdateState=function(a){a&&this.setActive(a===this.getObjectName())},d.static.name=a,d.static.group="povTools",d.static.icon=b,d.static.title=c,d},sp.ui.ext.ooui.Mod.Play.Toolbar=function(a,b,c){sp.ui.ext.ooui.Mod.Play.Toolbar.super.call(this,b,c),this.container=a},OO.inheritClass(sp.ui.ext.ooui.Mod.Play.Toolbar,OO.ui.Toolbar),sp.ui.ext.ooui.Mod.Play.Toolbar.prototype.getContainer=function(){return this.container},sp.ui.ext.ooui.Toolbar=function(a,b,c){sp.ui.ext.ooui.Toolbar.super.call(this,b,c),this.container=a},OO.inheritClass(sp.ui.ext.ooui.Toolbar,OO.ui.Toolbar),sp.ui.ext.ooui.Toolbar.prototype.getContainer=function(){return this.container},sp.ui.Loader=function(a){a=a||{},OO.EventEmitter.call(this),this.moduleName=a.module||"ooui",this.module=null,this.scenario=a.scenario,this.settings=a.settings||{},this.container=a.container,this.$spinner=$("<div>").addClass("sp-system-spinner").appendTo(this.container.$container)},OO.mixinClass(sp.ui.Loader,OO.EventEmitter),sp.ui.Loader.prototype.initialize=function(){var a;switch(this.module){case"ooui":default:this.module=new sp.ui.ext.ooui(this.container,this.settings)}return a=this.module.initialize(this.settings),this.$spinner.hide(),a},sp.ui.ext.Play=function(a,b){b=b||{},OO.EventEmitter.call(this),this.container=a},OO.mixinClass(sp.ui.ext.Play,OO.EventEmitter),sp.ui.ext.Play.prototype.initialize=function(){throw new Error("sp.Gui.Module.Initialize must be implemented in child class.")},sp.ui.ext.Play.prototype.addToPOVList=function(){throw new Error("sp.Gui.Module.addToPOVList must be implemented in child class.")},sp.ui.ext.ooui.Toolbar=function(a,b,c){sp.ui.ext.ooui.Toolbar.super.call(this,b,c),this.container=a},OO.inheritClass(sp.ui.ext.ooui.Toolbar,OO.ui.Toolbar),sp.ui.ext.ooui.Toolbar.prototype.getContainer=function(){return this.container},sp.view.Converter=function(a){OO.EventEmitter.call(this),this.config=a||{},this.zoom=this.config.zoom||1,this.orbit_scale=this.config.orbit_scale||1,this.centerPoint=this.config.centerPoint,this.yaw=this.config.yaw,this.pitch=this.config.pitch,this.pov={x:0,y:0,z:0},this.radii_list=null,this.radii={star:[25,30,32,35],planet:[4,8,10,12,14,16]},this.radius_step={star:0,planet:0}},OO.mixinClass(sp.view.Converter,OO.EventEmitter),sp.view.Converter.prototype.setPOV=function(a){a&&(a.x!==this.pov.x||a.y!==this.pov.y)&&(this.pov=a,this.emit("changePOV",a))},sp.view.Converter.prototype.getCoordinates=function(a){var b=Math.cos(this.yaw),c=Math.sin(this.yaw),d=Math.cos(this.pitch),e=Math.sin(this.pitch),f=this.centerPoint.x,g=this.centerPoint.y,h=Math.sqrt(this.orbit_scale*this.zoom);return x=(a.x-this.pov.x)*h,y=(a.y-this.pov.y)*h,z=(a.z-this.pov.z)*h,destination={x:x*b-y*c+f,y:x*c+y*b},destination.z=destination.y*e,destination.y=destination.y*d+g,destination},sp.view.Converter.prototype.setRadiiList=function(a){var b,c;this.radii_list=a;for(b in this.radii_list)this.radii_list[b].sort(function(a,b){return a-b}),c=this.radii_list[b][this.radii_list[b].length-1]-this.radii_list[b][0],this.radius_step[b]=c/this.radii[b].length},sp.view.Converter.prototype.getRadius=function(a,b){var c,d,e=this.radius_step[b]||1;return b=b||"planet",d=Math.floor(a/e),d>this.radii[b].length-1&&(d=this.radii[b].length-1),c=Math.sqrt(this.radii[b][d]*this.zoom)/100,c>=2?c:2},sp.view.Converter.prototype.setZoom=function(a){this.zoom+=a},sp.view.Converter.prototype.getZoom=function(){return this.zoom},sp.view.Converter.prototype.setCenterPoint=function(a,b){a=a||this.centerPoint.x,b=b||this.centerPoint.y,this.centerPoint={x:a,y:b}},sp.view.Converter.prototype.getCenterPoint=function(){return this.centerPoint},sp.view.Converter.prototype.addToCenterPoint=function(a,b){a=a||0,b=b||0,this.centerPoint.x+=a,this.centerPoint.y+=b};