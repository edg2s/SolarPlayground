<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='sp-view-Converter'>/**
</span> * Solar Playground view converter.
 * Converts between space coordinates and screen coordinates and controls the visual presentation.
 *
 * @class sp.view.Converter
 * @mixins OO.EventEmitter
 *
 * @param {Object} [config] Configuration object
 */
sp.view.Converter = function SpViewConverter( config ) {
	// Mixin constructors
	OO.EventEmitter.call( this );

	// Configuration
	this.config = config || {};

	this.zoom = this.config.zoom || 1;
	this.orbit_scale = this.config.orbit_scale || 1;
	this.yaw = this.config.yaw;
	this.pitch = this.config.pitch;

	this.canvasDimensions = this.config.canvasDimensions || { &#39;width&#39;: 0, &#39;height&#39;: 0 };
	this.centerPoint = {
		&#39;x&#39;: this.canvasDimensions.width / 2,
		&#39;y&#39;: this.canvasDimensions.height / 2
	};

	this.pov = { &#39;x&#39;: 0, &#39;y&#39;: 0, &#39;z&#39;: 0 };
	this.radii_list = null;

	// Set up visible canvas-scaled radius steps in pixels
	this.radii = {
		&#39;star&#39;: [ 25, 30, 32, 35 ],
		&#39;planet&#39;: [ 4, 8, 10, 12, 14, 16 ]
	};
	// Define the step between each value
	this.radius_step = {
		&#39;star&#39;: 0,
		&#39;planet&#39;: 0
	};
};

/* Inheritance */
OO.mixinClass( sp.view.Converter, OO.EventEmitter );

/* Events */

<span id='sp-view-Converter-event-changePOV'>/**
</span> * Change of the POV coordinates in space
 * @event changePOV
 * @param {Object} New space coordinates of the POV
 */

/* Methods */

<span id='sp-view-Converter-method-setPOV'>/**
</span> * Set the coordinates of the current POV object
 * @param {Object} pov_coords The 3d coordinates of the current POV
 * @fires changePOV
 */
sp.view.Converter.prototype.setPOV = function ( pov_coords ) {
	if ( !pov_coords ) {
		return;
	}
	if ( pov_coords.x !== this.pov.x || pov_coords.y !== this.pov.y ) {
		this.pov = pov_coords;
		this.emit( &#39;changePOV&#39;, pov_coords );
	}
};

<span id='sp-view-Converter-method-getCoordinates'>/**
</span> * Translate between space coordinates and viewpoint coordinates
 * on the canvas.
 * @param {Object} spaceCoords Original 3D space coordinates
 * @returns {Object} Canvas 2d coordinates
 */
sp.view.Converter.prototype.getCoordinates = function ( spaceCoords ) {
	var ca = Math.cos( this.yaw ),
		sa = Math.sin( this.yaw ),
		cb = Math.cos( this.pitch ),
		sb = Math.sin( this.pitch ),
		dx = this.centerPoint.x,
		dy = this.centerPoint.y,
		scale = Math.sqrt( this.orbit_scale * this.zoom );

	// TODO: Work out proper scale
	x = ( spaceCoords.x - this.pov.x ) * scale;
	y = ( spaceCoords.y - this.pov.y ) * scale;
	z = ( spaceCoords.z - this.pov.z ) * scale;

	destination = {
		&#39;x&#39;: x * ca - y * sa + dx,
		&#39;y&#39;: x * sa + y * ca
	};
	destination.z = destination.y * sb;
	destination.y = destination.y * cb + dy;

	// Check if destination is inside the canvas. Return null otherwise.
	if (
		destination.x &gt; 0 &amp;&amp;
		destination.x &lt;= this.canvasDimensions.width &amp;&amp;
		destination.y &gt; 0 &amp;&amp;
		destination.y &lt;= this.canvasDimensions.height
	) {
		return destination;
	}
};

<span id='sp-view-Converter-method-setRadiiList'>/**
</span> * Calculate radius size steps from a new radii list
 * @param {Object} rList Actual size radii of all celestial objects
 * divided into &#39;stars&#39; and &#39;planets&#39; to distinguish relative sizes better
 */
sp.view.Converter.prototype.setRadiiList = function ( rList ) {
	var type, diff;

	this.radii_list = rList;

	for ( type in this.radii_list ) {
		// Sort by size, ascending
		this.radii_list[type].sort( function ( a, b ) {
			return a - b;
		} );

		// Figure out steps for each of the types
		diff = this.radii_list[type][this.radii_list[type].length - 1] -
			this.radii_list[type][0];

		this.radius_step[type] = diff / this.radii[type].length
	}
};

<span id='sp-view-Converter-method-getRadius'>/**
</span> * Translate between the original radius and the canvas radius in pixels
 * @param {number} orig_radius Object&#39;s original radius
 * @returns {number} Actual radius in pixels
 */
sp.view.Converter.prototype.getRadius = function ( orig_radius, type ) {
	var radius, index,
		step = this.radius_step[type] || 1;

	type = type || &#39;planet&#39;;
	index = Math.floor( orig_radius / step );

	if ( index &gt; this.radii[type].length - 1 ) {
		index = this.radii[type].length - 1;
	}

	radius = Math.sqrt( this.radii[type][ index ] * this.zoom ) / 100;

	return ( radius &gt;= 2 ) ? radius : 2;
};

<span id='sp-view-Converter-method-setZoom'>/**
</span> * Increase or decrease scenario zoom levels
 * @param {number} z Zoom level, negative for zoom out
 */
sp.view.Converter.prototype.setZoom = function ( z ) {
	this.zoom += z;
};

<span id='sp-view-Converter-method-getZoom'>/**
</span> * Get the current zoom factor
 * @returns {number} zoom Zoom factor
 */
sp.view.Converter.prototype.getZoom = function () {
	return this.zoom;
};

<span id='sp-view-Converter-method-setCenterPoint'>/**
</span> * Set the canvas center point
 * @param {Object} coords x/y coordinates of the center of the system
 */
sp.view.Converter.prototype.setCenterPoint = function ( coords ) {
	coords = coords || {};

	x = coords.x || 0;
	y = coords.y || 0;

	this.centerPoint = {
		&#39;x&#39;: x,
		&#39;y&#39;: y
	};
};

<span id='sp-view-Converter-method-getCenterPoint'>/**
</span> * Get the current center point of the view
 * @returns {Object} x/y coordinates of the current center point
 */
sp.view.Converter.prototype.getCenterPoint = function () {
	return this.centerPoint;
};

<span id='sp-view-Converter-method-addToCenterPoint'>/**
</span> * Add to the center point
 * @param {number} [x] Amount to add to X coordinate
 * @param {number} [y] Amount to add to Y coordinate
 */
sp.view.Converter.prototype.addToCenterPoint = function ( x, y ) {
	x = x || 0;
	y = y || 0;

	this.centerPoint.x += x;
	this.centerPoint.y += y;
};
</pre>
</body>
</html>
